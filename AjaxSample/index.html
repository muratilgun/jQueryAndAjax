<!DOCTYPE html>
<html>

  <head>
    <title>Ajax Samples</title>

    <link rel="stylesheet" type="text/css" href="/styles/site.css">
  </head>

  <body>
    <h1>Ajax Samples</h1>
    <p>Bring up console window</p>

    <form>
      <div class="row">
        <label for="productID">Product ID</label>
        <input id="productID" name="productID" type="text" value="0" />
      </div>
      <div class="row">
        <label for="name">Product Name</label>
        <input id="name" name="name" type="text" value="A New Product" />
      </div>
      <div class="row">
        <label for="productNumber">Product Number</label>
        <input id="productNumber" name="productNumber" type="text" value="NEW-999" />
      </div>
      <div class="row">
        <label for="color">Color</label>
        <input id="color" name="color" type="text" value="Red" />
      </div>
      <div class="row">
        <label for="standardCost">Cost</label>
        <input id="standardCost" name="standardCost" type="number" value="10.00" />
      </div>
      <div class="row">
        <label for="listPrice">Price</label>
        <input id="listPrice" name="listPrice" type="number" value="25.00" />
      </div>
      <div class="row">
        <label for="sellStartDate">Sell Start Date</label>
        <input id="sellStartDate" name="sellStartDate" type="text" value="1/15/2021" />
      </div>
      <div class="row">
        <label id="message" class="infoMessage"></label>
        <label id="error" class="errorMessage"></label>
      </div>
      <div class="row">
        <button type="button" onclick="get();">
          Get Products
        </button>
        <button type="button" onclick="getProduct();">
          Get a Product
        </button>
        <button type="button" onclick="insertProduct();">
          Insert Product
        </button>
        <button type="button" onclick="updateProduct();">
          Update Product
        </button>
        <button type="button" onclick="deleteProduct();">
          Delete Product
        </button>
        <button type="button" onclick="incorrectTryCatch();">
          incorrect try..catch Product
        </button>

        <button type="button" onclick="correctTryCatch();">
          Correct try..catch Product
        </button>
      </div>
    </form>

    <script src="/scripts/ajax-common.js"></script>
    <script src="/scripts/product.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
      'use strict';

      const URL = "http://localhost:5000/api/product";
      //#region get_1_XMLHttpRequest
      //XMLHttpRequest
      // function get() {
      //   let req = new XMLHttpRequest();
      //   req.onreadystatechange = function () {
      //     if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
      //       console.log(this.response);
      //       displayMessage("Products Retrieved");
      //     }
      //   };
      //   req.open("GET", URL);
      //   req.send();
      // }
      //#endregion
      //#region getproduct_1
      // function getProduct() {
      //   let req = new XMLHttpRequest();
      //   req.onreadystatechange = function(){
      //     if(this.readyState === XMLHttpRequest.DONE && this.status === 200){
      //       displayMessage("Product Retrieved");
      //       console.log(this.response);
      //       setInput(JSON.parse(this.response));
      //     }
      //   };
      //   req.open("GET", URL + "/" + getValue("productID"));
      //   req.send();
      // }
      //#endregion 
      //#region insertProduct_1
      // function insertProduct() {
      //     let product = getFromInput();
      //     let req = new XMLHttpRequest();
      //     req.onreadystatechange = function() {
      //       if(this.readyState === XMLHttpRequest.DONE && this.status === 201){
      //         product = JSON.parse(this.response);
      //         displayMessage("Product Inserted");
      //         console.log(product);
      //         setInput(product);
      //       }else if(this.readyState === XMLHttpRequest.DONE && this.status >= 400){
      //           handleAjaxError({
      //             "status": this.status,
      //             "statusText": this.statusText,
      //             "response" : this.response,
      //             "responseText": this.responseText
      //           })
      //       }
      //     };
      //     req.open("POST", URL);
      //     req.setRequestHeader("Content-Type","application/json");
      //     req.send(JSON.stringify(product));
      // }
      // #endregion
      //#region get_2_fetch_api
      // function get() {
      //   fetch(URL)
      //   .then(response => response.json())
      //   .then(data => console.log(data))
      //   .catch(error=> handleAjaxError(error));
      // }
      
      // function getWithOptions(){
      //   fetch(URL, {
      //     method: 'GET',                //GET,POST,PUT,DELETE, etc.
      //     mode: 'cors',                 // cors, no-cors, *cors, same-origin 
      //     cache: 'no-cache',            // *default, no-cache, reload,
      //                                   //  force-cache, only-if-cache
      //     credentials: 'same-origin',    // include, *same-origin, omit
      //     headers :{
      //       'Content-Type': 'application/json'
      //     }
      //   })
      //   .then(response=> response.json())
      //   .then(data => console.log(data))
      //   .catch(error => handleAjaxError(error));
      // }
      // #endregion
      //#region get_3_handling_error
      let _lastStatus = {
        "status": 0,
        "statusText" : "",
        "ok" : false
      }
      function get(){
        fetch(URL)
        .then(response => processResponse(response))
        .then(data=> {
          if(_lastStatus.ok){
            displayMessage("Products Retrieved");
            console.log(data);
          }
          else{
            displayError(_lastStatus.statusText);
          }
        })
        .catch(error => handleAjaxError(error));
      }
      
      function processResponse(resp) {
        _lastStatus.status = resp.status;
        _lastStatus.statusText = resp.statusText;
        _lastStatus.ok =resp.ok;

        console.log(_lastStatus);
        if(_lastStatus.ok){
          return resp.json();
        } else {
          return null;
        }
      }
      // #endregion
      //#region get_4_ajax_callbacks
      // function get() {
      //   $.ajax({
      //     url: URL,
      //     type: 'GET',
      //     contentType: "application/json",
      //     success: function (data) {
      //         displayMessage("Products Retrieved");
      //         console.log(data);
      //       },
      //     error: function(error){
      //       handleAjaxError(error);
      //     },
      //     complete: function () {  
      //       console.log("In the complete function");
      //     }
      //   });
      // }
      // #endregion
      //#region get_5_done_fail_always
      function get() {
        $.ajax(URL)
        .done(function(data){
          displayMessage("Products Retrieved");
          console.log(data);
        })
        .fail(function (error) {
          handleAjaxError(error);
          })
        .always(function () {
           console.log("In the always() method");
          });
        }
      // #endregion
      //#region getProduct_2_promises
      function getProduct() { 
        $.ajax(URL + "/" + getValue("productID"))
        .done(function(data){
          displayMessage("Product Retrieved");
          console.log(data);
          setInput(data);
        })
        .fail(function(error){
          handleAjaxError(error);
        })
        .always(function () {
          console.log("In the always() method");
        });
       }
      //#endregion
      //#region insertProduct_2
      // function insertProduct(){
      //   let product = getFromInput();
      //   let options  = {
      //     method: 'POST',
      //     headers: { 'Content-Type' : 'application/json'},
      //     body: JSON.stringify(product)
      //   };
      //   fetch(URL, options)
      //   .then(response => response.json()
      //   .then(data=> {
      //     console.log(data);
      //     setInput(data);
      //   }).catch(error=> handleAjaxError(error)))
      // }
      //#endregion
      //#region insertProduct_3_promises
      function insertProduct(){
        let product = getFromInput();
        $.ajax({
          url: URL,
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(product)
        }).done(function(data){
          displayMessage("Product Inserted");
          console.log(data);
          setInput(data);
        })
        .fail(function (error) {
          handleAjaxError(error);
        })
        .always(function(){

        });
          
      }
      //#endregion
      //#region module_4
      function updateProduct() {
        let product = getFromInput();
        $.ajax({
          url: URL + "/" + product.productID,
          type: "PUT",
          contentType: "application/json",
          data: JSON.stringify(product)
        })
        .done(function (data) {
          displayMessage("Product Inserted");
          console.log(data);
          setInput(data);
          })
          .fail(function(error){
            handleAjaxError(error);
          })
          .always(function(){

          });
      }

      function deleteProduct() {
        $.ajax({
          url: URL + "/" + getValue("productID"),
          type: "DELETE"
        })
        .done(function(data){
          displayMessage("Product Deleted");
          console.log(data);
          clearInput();
        })
        .fail(function (error) {
          handleAjaxError(error);
        })
        .always(function(){
        });
        
      }
      
      function incorrectTryCatch() { 
        try {
          console.log("In the try block");
          $.ajax({
            url: URL,
            type: 'GET',
            contentType: "application/json"
          })
          .done(function(data){
            console.log("Retrieved the data");
            console.log(data);
          })
          .fail(function(error){
            handleAjaxError(error);
          })
          .always(function(){
             console.log("In the always() method");
          });
        } catch (error) {
          console.log("In the catch block");
          console.error(error);
        }
        finally{
          console.log("In the finally block");
        }
        console.log("Ending this function");
       }
       
      function correctTryCatch(){
        $.ajax({
          url: URL,
          type: 'GET',
          contentType: "application/json"
        })
        .done(function(data){
          // try..catch herhangi bir promise methodunun içerisinde yer alabilir.
          try {
            console.log(data);
          } catch (error) {
            console.log(error);
          }
        })
        .fail(function(error){
          // try..catch herhangi bir promise methodunun içerisinde yer alabilir.
          handleAjaxError(error);
        })
        .always(function(){
          // try..catch herhangi bir promise methodunun içerisinde yer alabilir.
          console.log("In the always() methods");
        })
      }
      
      //#endregion
      //#region global_Event_Handlers
      $(document).ajaxStart(function () {
        console.log("The first Ajax call is being fired");
      })
      $(document).ajaxStop(function(){
        console.log("The last Ajax call has completed");
      })

      $(document).ajaxSend(function () {
        console.log("Ajax call is being sent");
      })
      $(document).ajaxSend(function (event,xhr,settings) {
        console.log(settings);
      })
      //#endregion
   </script>
  </body>

</html>